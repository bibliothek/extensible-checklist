---
phase: 09-docker-azure-update
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified: [.github/workflows/azure-deploy.yml, docs/DEPLOYMENT.md]
autonomous: false

user_setup:
  - service: azure-files
    why: "Persistent SQLite database storage across container deployments"
    env_vars:
      - name: AZURE_STORAGE_ACCOUNT
        source: "Azure Portal -> Storage accounts -> <your-account> -> Access keys -> Storage account name"
      - name: AZURE_STORAGE_KEY
        source: "Azure Portal -> Storage accounts -> <your-account> -> Access keys -> key1 or key2"
      - name: AZURE_STORAGE_SHARE
        source: "Azure Portal -> Storage accounts -> <your-account> -> File shares -> <share-name>"
    dashboard_config:
      - task: "Create Azure Storage Account"
        location: "Azure Portal -> Storage accounts -> Create"
        details: "Choose same region as App Service, Standard performance tier, LRS replication"
      - task: "Create Azure File Share"
        location: "Azure Portal -> Storage accounts -> <account> -> File shares -> + File share"
        details: "Name it 'checklist-data', use 5GB quota (minimum)"
      - task: "Configure App Service volume mount"
        location: "Azure Portal -> App Service -> <your-app> -> Configuration -> Path mappings"
        details: "Add Azure Storage mount: Name=database, Type=Azure Files, Storage account=<account>, Share=checklist-data, Mount path=/app/data"
      - task: "Update GitHub repository secrets"
        location: "GitHub -> Repository -> Settings -> Secrets and variables -> Actions"
        details: "No new secrets needed, existing ones sufficient (REGISTRY_*, AZURE_WEBAPP_*)"

must_haves:
  truths:
    - "GitHub Actions workflow deploys SQLite-based application to Azure"
    - "Production container persists database across deployments"
    - "Deployment documentation reflects SQLite + Azure Files architecture"
  artifacts:
    - path: ".github/workflows/azure-deploy.yml"
      provides: "CI/CD pipeline for SQLite deployment"
      contains: "DATABASE_URL"
    - path: "docs/DEPLOYMENT.md"
      provides: "Complete Azure deployment guide"
      min_lines: 100
  key_links:
    - from: ".github/workflows/azure-deploy.yml"
      to: "Azure Container Registry"
      via: "docker build and push"
      pattern: "docker.*push"
    - from: "Azure App Service"
      to: "Azure Files"
      via: "volume mount configuration"
      pattern: "/app/data"
---

<objective>
Update Azure deployment pipeline to support SQLite with Azure Files storage for database persistence.

Purpose: Remove PostgreSQL dependency from production deployment and configure Azure Files for SQLite database persistence across container restarts and deployments.
Output: Updated GitHub Actions workflow and deployment documentation for SQLite-based Azure deployment with persistent storage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-docker-azure-update/09-01-SUMMARY.md
@.planning/phases/07-production-deployment/07-01-SUMMARY.md
@.planning/phases/08-database-migration/08-01-SUMMARY.md

Current state:
- GitHub Actions workflow references PostgreSQL setup
- No Azure Files configuration for SQLite persistence
- DATABASE_URL format needs to be file-based for production
- App Service expects DATABASE_URL environment variable

Phase 9 Plan 1 completed:
- Docker configuration verified SQLite-compatible
- docker-compose.yml provides local volume mount pattern
- DATABASE_URL format: "file:/app/data/dev.db"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GitHub Actions workflow for SQLite deployment</name>
  <files>.github/workflows/azure-deploy.yml</files>
  <action>
Update azure-deploy.yml to remove PostgreSQL references and document Azure Files requirement.

Changes needed:
1. Add comment block at top of file documenting Azure Files prerequisite:
   ```yaml
   # Prerequisites:
   # - Azure Container Registry (ACR) created
   # - Azure App Service (Linux Container) created
   # - Azure Storage Account with File Share created
   # - App Service configured with Azure Files volume mount at /app/data
   # - GitHub secrets configured (REGISTRY_*, AZURE_WEBAPP_*)
   ```

2. Update workflow environment variables section to document DATABASE_URL:
   ```yaml
   # Environment variables are configured in Azure App Service:
   # - DATABASE_URL=file:/app/data/dev.db
   # - NEXTAUTH_URL=https://<your-app>.azurewebsites.net
   # - NEXTAUTH_SECRET=<generated-secret>
   ```

3. No changes to workflow steps needed - existing build/push/deploy steps work for SQLite.

4. Update health check step comment to mention migration initialization:
   - Change "Waiting 30 seconds for container startup and migrations..."
   - To "Waiting 30 seconds for container startup, SQLite initialization, and migrations..."

The workflow already handles container deployment correctly. This task adds documentation about SQLite-specific requirements.
  </action>
  <verify>
Run `cat .github/workflows/azure-deploy.yml | grep -i "sqlite\|file:/app/data"` and confirm:
- Comments document Azure Files prerequisite
- DATABASE_URL file path format is documented
- Health check comment mentions SQLite initialization
  </verify>
  <done>
GitHub Actions workflow updated with SQLite deployment documentation. Workflow steps unchanged (already compatible). Comments clarify Azure Files and DATABASE_URL requirements.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive deployment documentation</name>
  <files>docs/DEPLOYMENT.md</files>
  <action>
Create docs/DEPLOYMENT.md with complete Azure deployment guide for SQLite-based application.

Structure:

# Azure Deployment Guide

## Overview
- Application architecture: Next.js + SQLite + Azure Files
- No separate database service required
- Database persists in Azure Files across deployments

## Prerequisites
1. Azure subscription
2. Azure CLI installed locally
3. GitHub repository with code
4. Docker installed locally (for testing)

## Step-by-Step Deployment

### 1. Create Azure Resources

#### 1.1 Create Resource Group
```bash
az group create --name checklist-rg --location eastus
```

#### 1.2 Create Azure Container Registry
```bash
az acr create --resource-group checklist-rg --name checklistacrXXXX --sku Basic
az acr login --name checklistacrXXXX
```

#### 1.3 Create Azure Storage Account
```bash
az storage account create \
  --name checkliststorageXXXX \
  --resource-group checklist-rg \
  --location eastus \
  --sku Standard_LRS
```

#### 1.4 Create Azure File Share
```bash
az storage share create \
  --account-name checkliststorageXXXX \
  --name checklist-data \
  --quota 5
```

#### 1.5 Create App Service Plan
```bash
az appservice plan create \
  --name checklist-plan \
  --resource-group checklist-rg \
  --is-linux \
  --sku B1
```

#### 1.6 Create Web App
```bash
az webapp create \
  --resource-group checklist-rg \
  --plan checklist-plan \
  --name checklist-app-XXXX \
  --deployment-container-image-name checklistacrXXXX.azurecr.io/extensible-checklist:latest
```

### 2. Configure Azure Files Volume Mount

#### 2.1 Get Storage Account Key
```bash
STORAGE_KEY=$(az storage account keys list \
  --account-name checkliststorageXXXX \
  --resource-group checklist-rg \
  --query "[0].value" -o tsv)
```

#### 2.2 Add Volume Mount to App Service
```bash
az webapp config storage-account add \
  --resource-group checklist-rg \
  --name checklist-app-XXXX \
  --custom-id database \
  --storage-type AzureFiles \
  --account-name checkliststorageXXXX \
  --share-name checklist-data \
  --access-key "$STORAGE_KEY" \
  --mount-path /app/data
```

### 3. Configure Environment Variables

```bash
# Generate NEXTAUTH_SECRET
NEXTAUTH_SECRET=$(openssl rand -base64 32)

# Set environment variables
az webapp config appsettings set \
  --resource-group checklist-rg \
  --name checklist-app-XXXX \
  --settings \
    DATABASE_URL="file:/app/data/dev.db" \
    NEXTAUTH_URL="https://checklist-app-XXXX.azurewebsites.net" \
    NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
    WEBSITES_PORT=3000
```

### 4. Configure GitHub Secrets

Add the following secrets to your GitHub repository (Settings -> Secrets and variables -> Actions):

- `REGISTRY_LOGIN_SERVER`: checklistacrXXXX.azurecr.io
- `REGISTRY_USERNAME`: Get from `az acr credential show --name checklistacrXXXX --query username -o tsv`
- `REGISTRY_PASSWORD`: Get from `az acr credential show --name checklistacrXXXX --query passwords[0].value -o tsv`
- `AZURE_WEBAPP_NAME`: checklist-app-XXXX
- `AZURE_WEBAPP_PUBLISH_PROFILE`: Get from Azure Portal -> App Service -> Download publish profile

### 5. Deploy Application

Push to main branch or manually trigger workflow:
```bash
git push origin main
```

Monitor deployment in GitHub Actions tab.

### 6. Verify Deployment

1. Check health endpoint: `https://checklist-app-XXXX.azurewebsites.net/api/health`
2. Access application: `https://checklist-app-XXXX.azurewebsites.net`
3. Create test account and verify database persistence

## Architecture Details

### Database Persistence
- SQLite database file stored in Azure Files
- Mount path: /app/data
- Database file: /app/data/dev.db
- Persists across container restarts and deployments

### Container Startup Flow
1. Container starts from ACR image
2. Azure mounts File Share to /app/data
3. migrate-and-start.sh runs Prisma migrations
4. If database doesn't exist, migrations create it
5. Next.js server starts on port 3000

### Cost Estimate
- App Service B1: ~$13/month
- Azure Container Registry Basic: ~$5/month
- Azure Storage (5GB File Share): ~$0.25/month
- **Total: ~$18/month**

## Troubleshooting

### Database file not persisting
- Check volume mount configuration: `az webapp config storage-account list`
- Verify mount path is /app/data
- Check storage account key is correct

### Migrations failing
- Check DATABASE_URL format: must be "file:/app/data/dev.db"
- Check logs: `az webapp log tail --name checklist-app-XXXX --resource-group checklist-rg`
- Verify /app/data is writable by container user (nextjs:1001)

### Container not starting
- Check environment variables are set
- Verify ACR credentials in GitHub secrets
- Check App Service logs for errors

## Maintenance

### View Logs
```bash
az webapp log tail --name checklist-app-XXXX --resource-group checklist-rg
```

### Restart App Service
```bash
az webapp restart --name checklist-app-XXXX --resource-group checklist-rg
```

### Backup Database
```bash
az storage file download \
  --account-name checkliststorageXXXX \
  --share-name checklist-data \
  --path dev.db \
  --dest ./backup-dev.db
```

### Update Environment Variables
```bash
az webapp config appsettings set \
  --resource-group checklist-rg \
  --name checklist-app-XXXX \
  --settings KEY=VALUE
```

Create docs/ directory if it doesn't exist. Write this complete guide to docs/DEPLOYMENT.md.
  </action>
  <verify>
Run checks:
1. `ls docs/DEPLOYMENT.md` - file exists
2. `wc -l docs/DEPLOYMENT.md` - confirm 200+ lines
3. `grep -i "azure files" docs/DEPLOYMENT.md` - confirms Azure Files documentation
4. `grep "file:/app/data/dev.db" docs/DEPLOYMENT.md` - confirms DATABASE_URL format
  </verify>
  <done>
docs/DEPLOYMENT.md created with comprehensive Azure deployment guide. All Azure CLI commands documented. Troubleshooting section included. Architecture and cost estimate provided.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-built>
Updated GitHub Actions workflow and comprehensive deployment documentation for SQLite + Azure Files deployment.
  </what-built>

  <action>
Configure Azure Files storage and App Service volume mount. This requires Azure Portal access and cannot be automated via GitHub Actions.
  </action>

  <instructions>
Follow the deployment guide to set up Azure infrastructure:

**If you have an EXISTING Azure App Service from Phase 7:**

1. **Create Azure Storage Account:**
   - Azure Portal -> Storage accounts -> Create
   - Name: checklist-storage-XXXX (must be globally unique)
   - Region: Same as your App Service
   - Performance: Standard
   - Replication: LRS (Locally-redundant storage)
   - Click "Review + Create" -> Create

2. **Create File Share:**
   - Navigate to your new Storage Account
   - Left sidebar -> File shares -> + File share
   - Name: checklist-data
   - Quota: 5 GiB (minimum)
   - Click Create

3. **Get Storage Account Key:**
   - Storage account -> Access keys
   - Click "Show" next to key1
   - Copy the Key value (keep this secure)

4. **Configure App Service Volume Mount:**
   - Navigate to your App Service
   - Left sidebar -> Configuration -> Path mappings
   - Scroll to "Azure Storage mounts" section
   - Click "+ New Azure Storage Mount"
   - Fill in:
     - Name: database
     - Configuration: Basic
     - Storage accounts: Select your storage account
     - Storage type: Azure Files
     - Storage container: checklist-data
     - Mount path: /app/data
   - Click OK
   - Click Save at top of page

5. **Update App Service Environment Variables:**
   - Still in Configuration -> Application settings
   - Find DATABASE_URL setting
   - Update value to: file:/app/data/dev.db
   - Click Save at top of page
   - Restart App Service (Overview -> Restart)

**If you DON'T have an existing Azure deployment:**
   - Follow docs/DEPLOYMENT.md from the beginning
   - Complete all steps in Section 1-3
   - Then proceed to verify deployment below

**Verification:**
After configuration, verify deployment:
1. Visit your App Service URL (e.g., https://checklist-app-XXXX.azurewebsites.net/api/health)
2. Should return: {"status":"healthy","timestamp":"..."}
3. Visit root URL and create a test account
4. Restart App Service via Azure Portal
5. Log in again - if login works, database persisted correctly

**Common Issues:**
- If health check fails: Check App Service logs (Monitoring -> Log stream)
- If migrations fail: Verify DATABASE_URL format is exactly "file:/app/data/dev.db"
- If database doesn't persist: Check Path mappings shows /app/data mount
  </instructions>

  <resume-signal>
Type "deployed" when Azure Files is configured and application is running, or describe any issues encountered.
  </resume-signal>
</task>

</tasks>

<verification>
After checkpoint completes and user confirms deployment:

1. **GitHub Actions verification:**
   - Review workflow file has updated comments
   - Confirm no PostgreSQL references remain

2. **Deployment documentation verification:**
   - docs/DEPLOYMENT.md exists with 200+ lines
   - Azure Files setup is documented
   - All required az CLI commands are present
   - Troubleshooting section covers common issues

3. **Production deployment verification (user-confirmed):**
   - Application accessible at Azure URL
   - Health endpoint returns 200 OK
   - Database persists across App Service restarts
   - No PostgreSQL service in Azure resource group
</verification>

<success_criteria>
- GitHub Actions workflow updated for SQLite deployment
- docs/DEPLOYMENT.md provides complete Azure Files setup guide
- Azure Files storage account configured (user setup)
- App Service volume mount configured at /app/data (user setup)
- DATABASE_URL environment variable set to file:/app/data/dev.db (user setup)
- Production application runs with persistent SQLite database
- All AZ-01, AZ-02, AZ-03, AZ-04 requirements met
</success_criteria>

<output>
After completion, create `.planning/phases/09-docker-azure-update/09-02-SUMMARY.md` following the summary template.

Include:
- GitHub Actions workflow changes (documentation updates)
- Deployment guide structure and key sections
- User-reported results from Azure Files configuration
- Verification results from production deployment
- Confirmation that all Phase 9 requirements (DOCK-01 through AZ-04) are complete
- Cost estimate from Azure deployment (approximately $18/month without PostgreSQL)
</output>
