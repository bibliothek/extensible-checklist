---
phase: 03-template-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - app/api/templates/route.ts
  - app/api/templates/[id]/route.ts
  - app/api/templates/[id]/items/route.ts
autonomous: true

must_haves:
  truths:
    - "Template data persists in database with user association"
    - "Template items belong to templates in correct order"
    - "API endpoints respond with proper authentication checks"
    - "User can only access their own templates via API"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Template and TemplateItem models"
      contains: "model Template"
    - path: "app/api/templates/route.ts"
      provides: "Template list and creation endpoints"
      exports: ["GET", "POST"]
    - path: "app/api/templates/[id]/route.ts"
      provides: "Template read, update, delete endpoints"
      exports: ["GET", "PUT", "DELETE"]
    - path: "app/api/templates/[id]/items/route.ts"
      provides: "Template item management"
      exports: ["POST", "PUT", "DELETE"]
  key_links:
    - from: "app/api/templates/route.ts"
      to: "prisma.template"
      via: "database queries with user filter"
      pattern: "prisma\\.template\\.(findMany|create)"
    - from: "app/api/templates/[id]/route.ts"
      to: "auth session"
      via: "getServerSession for user ID"
      pattern: "getServerSession.*authOptions"
---

<objective>
Build the database schema and API foundation for template management, enabling users to create, read, update, and delete templates with associated checklist items.

Purpose: Establish the data layer and API contracts that the UI will consume in subsequent plans
Output: Working database models and authenticated API endpoints for template CRUD operations
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-template-system/03-template-system-CONTEXT.md

# Prior phase summaries
@.planning/phases/02-authentication/02-01-SUMMARY.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

# Key files
@prisma/schema.prisma
@auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Template and TemplateItem database models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Template and TemplateItem models to the Prisma schema with the following structure:

**Template model:**
- id: String @id @default(cuid())
- name: String (template name, e.g., "Morning Routine")
- userId: String (foreign key to User)
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt
- user: User relation
- items: TemplateItem[] relation (one-to-many)

**TemplateItem model:**
- id: String @id @default(cuid())
- text: String (checklist item text)
- order: Int (position in template, 0-indexed)
- templateId: String (foreign key to Template)
- createdAt: DateTime @default(now())
- template: Template relation

Add the templates relation to the User model: `templates Template[]`

After modifying the schema, run `npx prisma db push` to apply changes to the database, then run `npx prisma generate` to update the Prisma client types.
  </action>
  <verify>
Run `npx prisma db push` and `npx prisma generate` successfully. Check that TypeScript types are available for Template and TemplateItem in IDE.
  </verify>
  <done>
Database schema includes Template and TemplateItem models with proper relations. Prisma client types are generated and ready for use in API routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create template CRUD API endpoints</name>
  <files>
app/api/templates/route.ts
app/api/templates/[id]/route.ts
app/api/templates/[id]/items/route.ts
  </files>
  <action>
Create three API route files for template management with proper authentication and user isolation.

**app/api/templates/route.ts:**
- GET: Return all templates for authenticated user (prisma.template.findMany with userId filter, include items ordered by order field)
- POST: Create new template with name and items array [{text, order}], associate with authenticated user, return created template with items

**app/api/templates/[id]/route.ts:**
- GET: Return single template by id with items included, verify user owns template (return 404 if not found or not owned)
- PUT: Update template name and/or items (replace all items), verify ownership, return updated template
- DELETE: Delete template and cascade delete items (Prisma handles cascade), verify ownership, return 204

**app/api/templates/[id]/items/route.ts:**
- POST: Add new item to template, assign next order number
- PUT: Update item text or order (reorder within template)
- DELETE: Delete specific item, renumber remaining items

Use getServerSession(authOptions) from auth.ts to get authenticated user ID. Return 401 if not authenticated. Use Prisma client singleton from prisma.config.ts. Follow established error handling pattern from signup route (try/catch with JSON error response). Return proper status codes (200, 201, 204, 400, 401, 404).
  </action>
  <verify>
Run `npm run dev` and test API endpoints with curl:
- POST /api/templates creates template for authenticated user
- GET /api/templates returns only user's templates
- PUT /api/templates/[id] updates only user's templates (404 for other users)
- DELETE /api/templates/[id] removes template and items
  </verify>
  <done>
All template API endpoints exist, require authentication, enforce user isolation, and handle CRUD operations correctly. API responds with proper status codes and error messages.
  </done>
</task>

</tasks>

<verification>
1. Database models exist: `npx prisma studio` shows Template and TemplateItem tables
2. API authentication works: Unauthenticated requests return 401
3. User isolation enforced: User A cannot access User B's templates
4. CRUD operations work: Create, read, update, delete templates via API
</verification>

<success_criteria>
- Template and TemplateItem models exist in Prisma schema
- Database migrations applied successfully
- API endpoints created for template CRUD operations
- All endpoints require authentication via Auth.js session
- User can only access their own templates (userId filter applied)
- API returns proper status codes and error handling
- Manual API testing with curl confirms all operations work
</success_criteria>

<output>
After completion, create `.planning/phases/03-template-system/03-01-SUMMARY.md`
</output>
