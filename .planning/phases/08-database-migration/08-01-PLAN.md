---
phase: 08-database-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - .env.example
  - .env
  - prisma/migrations/
autonomous: true

must_haves:
  truths:
    - "Application starts without PostgreSQL server running"
    - "Database operations read/write to local SQLite file"
    - "All existing database queries work identically with SQLite"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "SQLite datasource configuration"
      contains: 'provider = "sqlite"'
    - path: ".env.example"
      provides: "SQLite connection string template"
      contains: "file:./dev.db"
    - path: "prisma/migrations/"
      provides: "SQLite migration baseline"
      min_files: 1
  key_links:
    - from: "prisma/schema.prisma"
      to: "datasource db.provider"
      via: "provider field"
      pattern: 'provider\s*=\s*"sqlite"'
    - from: ".env"
      to: "DATABASE_URL"
      via: "environment variable"
      pattern: "DATABASE_URL.*file:"
    - from: "lib/db.ts"
      to: "@prisma/client"
      via: "PrismaClient import"
      pattern: "PrismaClient"
---

<objective>
Migrate application database from PostgreSQL to SQLite for simplified deployment and reduced infrastructure complexity.

Purpose: Replace PostgreSQL dependency with file-based SQLite database, eliminating need for separate database service and reducing deployment complexity for v2.1 milestone.

Output: Application using SQLite with all existing features working identically, ready for Docker and Azure deployment updates in Phase 9.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Current database setup
@prisma/schema.prisma
@lib/db.ts
@.env.example

# Key files using Prisma (no changes needed, just for verification)
@app/api/auth/signup/route.ts
@app/api/templates/route.ts
@app/api/checklists/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma schema to SQLite provider</name>
  <files>prisma/schema.prisma</files>
  <action>
Update Prisma schema datasource to use SQLite provider:

1. Change datasource provider from "postgresql" to "sqlite"
2. Keep datasource url pointing to env("DATABASE_URL")
3. No model changes needed - Prisma handles type mapping automatically
4. Important: SQLite uses different syntax for some field types:
   - @default(cuid()) works fine
   - @default(now()) works fine
   - Relations and cascades work fine
   - Int, String, DateTime, Boolean all supported

The schema models are already compatible with SQLite. Just change the provider line.
  </action>
  <verify>
Run `npx prisma validate` to ensure schema is valid for SQLite.
Output should show no errors and confirm SQLite provider is detected.
  </verify>
  <done>
prisma/schema.prisma datasource provider is "sqlite", schema validates successfully with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update environment configuration for SQLite</name>
  <files>.env.example, .env</files>
  <action>
Update DATABASE_URL environment variable format for SQLite file path:

1. Update .env.example:
   - Change DATABASE_URL from PostgreSQL connection string
   - Use SQLite file path format: "file:./dev.db"
   - Keep NEXTAUTH_URL and NEXTAUTH_SECRET unchanged
   - Add comment explaining SQLite file path

2. Update .env (local development):
   - Same DATABASE_URL change: "file:./dev.db"
   - Preserve existing NEXTAUTH_SECRET value (don't regenerate)

SQLite file path format:
- "file:./dev.db" -> creates dev.db in project root
- "file:./prisma/dev.db" -> creates in prisma/ directory (alternative)
- Path is relative to where process runs from

Use "./dev.db" in root for simplicity (matches Prisma convention).
  </action>
  <verify>
Check .env.example and .env both have DATABASE_URL="file:./dev.db" format.
Run `echo $DATABASE_URL` or `cat .env` to confirm environment variable is set correctly.
  </verify>
  <done>
Both .env.example and .env contain DATABASE_URL with "file:./dev.db" format. NEXTAUTH_SECRET preserved in .env.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate SQLite migration baseline</name>
  <files>prisma/migrations/</files>
  <action>
Create initial migration for SQLite database:

1. Generate Prisma Client with new SQLite provider:
   `npx prisma generate`

2. Create initial migration baseline:
   `npx prisma migrate dev --name init`

   This will:
   - Create prisma/migrations/ directory
   - Generate migration SQL for all models
   - Create dev.db file in project root
   - Apply migration to new SQLite database

3. Verify database was created:
   - Check that dev.db exists in project root
   - Run `npx prisma studio` to open database browser
   - Confirm all tables exist: User, Account, Session, VerificationToken, Template, TemplateItem, Checklist, ChecklistItem

4. Test basic database operations:
   - Start dev server: `npm run dev`
   - Visit signup page and create test account
   - Verify account creation works with SQLite
   - Check database with `npx prisma studio` shows new user

Important: If dev server is running, stop it before running migrations.
  </action>
  <verify>
1. `ls prisma/migrations/` shows migration directory with timestamped migration folder
2. `ls dev.db` shows SQLite database file exists
3. `npx prisma studio` opens and shows all 8 tables with correct schema
4. Test account creation works: signup -> login -> sees templates page
  </verify>
  <done>
prisma/migrations/ exists with initial migration. dev.db created and contains all tables. Application starts successfully, and signup/login flow works with SQLite backend.
  </done>
</task>

</tasks>

<verification>
Comprehensive verification that SQLite migration is complete:

1. Schema validation:
   - `npx prisma validate` passes with no errors
   - prisma/schema.prisma shows provider = "sqlite"

2. Migration baseline:
   - prisma/migrations/ directory exists with initial migration
   - dev.db file exists in project root
   - All 8 tables present in database (verify with prisma studio)

3. Application functionality:
   - `npm run dev` starts without PostgreSQL dependency
   - Signup flow: create new user account
   - Login flow: authenticate with created account
   - Templates: create, edit, delete template
   - Checklists: instantiate from template, check items
   - All features work identically to PostgreSQL version

4. Environment configuration:
   - .env has DATABASE_URL="file:./dev.db"
   - .env.example updated with SQLite format
   - NEXTAUTH_SECRET preserved (not regenerated)

5. No regression:
   - lib/db.ts unchanged (PrismaClient works transparently)
   - All API routes unchanged (Prisma queries are database-agnostic)
   - No code changes needed outside schema and env config
</verification>

<success_criteria>
Phase 8 complete when:

1. Prisma schema uses SQLite provider (DB-01 satisfied)
2. DATABASE_URL configured for SQLite file path in .env and .env.example (DB-02 satisfied)
3. Initial migration generated and applied to SQLite database (DB-03 satisfied)
4. Application runs locally with SQLite backend
5. Full user workflow verified: signup -> login -> templates -> checklists
6. dev.db file present with all data persisted
7. No PostgreSQL dependency required for local development

Ready for Phase 9: Docker and Azure deployment updates.
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-migration/08-01-SUMMARY.md` following the summary template format.
</output>
