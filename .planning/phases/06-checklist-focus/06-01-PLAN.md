---
phase: 06-checklist-focus
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - app/api/checklists/[id]/route.ts
  - app/checklists/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle hide/show completed button on checklist detail page"
    - "When hide completed is ON, checked items disappear from view"
    - "When hide completed is ON, template groups with all items checked disappear"
    - "Hide/show preference persists across page refreshes"
    - "Each checklist remembers its own hide/show preference independently"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "hideCompleted field on Checklist model"
      contains: "hideCompleted\\s+Boolean"
    - path: "app/api/checklists/[id]/route.ts"
      provides: "PATCH handler for updating hideCompleted preference"
      exports: ["PATCH"]
    - path: "app/checklists/[id]/page.tsx"
      provides: "Toggle button and filtering logic for hide completed"
      contains: "hideCompleted"
  key_links:
    - from: "app/checklists/[id]/page.tsx"
      to: "app/api/checklists/[id]/route.ts"
      via: "PATCH request on toggle"
      pattern: "fetch.*checklists.*PATCH"
    - from: "app/api/checklists/[id]/route.ts"
      to: "prisma.checklist"
      via: "database update"
      pattern: "prisma\\.checklist\\.update"
---

<objective>
Add hide completed functionality to checklists, allowing users to focus on remaining work by hiding checked items and fully completed template groups.

Purpose: Reduce visual clutter on long checklists by letting users hide completed work while maintaining focus on what's left to do.
Output: Hide/show completed toggle in checklist detail view with per-checklist persistence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@app/checklists/[id]/page.tsx
@app/api/checklists/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hideCompleted field to database schema and API</name>
  <files>
    prisma/schema.prisma
    app/api/checklists/[id]/route.ts
  </files>
  <action>
Add hideCompleted field to Checklist model in prisma/schema.prisma:
- Add Boolean field `hideCompleted` with default value `false`
- Run `npx prisma db push` to apply schema change to database

Extend existing PATCH handler in app/api/checklists/[id]/route.ts:
- Accept `hideCompleted` in request body (optional boolean)
- Update checklist record with hideCompleted value
- Verify ownership before update (use existing pattern from DELETE handler)
- Return updated checklist with hideCompleted field included
- Handle errors appropriately (401 for unauthorized, 404 for not found, 500 for server error)

Follow established patterns:
- Use getServerSession for authentication
- Use prisma.checklist.findUnique with userId check for ownership verification
- Use prisma.checklist.update for atomic update
  </action>
  <verify>
Run `npx prisma db push` successfully without errors.
Test PATCH endpoint with curl or Postman:
```bash
curl -X PATCH http://localhost:3000/api/checklists/{id} \
  -H "Content-Type: application/json" \
  -d '{"hideCompleted": true}'
```
Verify response includes hideCompleted field and database record is updated.
  </verify>
  <done>
- Checklist model has hideCompleted Boolean field with default false
- PATCH /api/checklists/[id] accepts hideCompleted and updates database
- API returns updated checklist including hideCompleted field
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement hide completed toggle and filtering in UI</name>
  <files>
    app/checklists/[id]/page.tsx
  </files>
  <action>
Update checklist detail page to support hide completed functionality:

1. Add hideCompleted state (initialize from fetched checklist.hideCompleted, default false)

2. Add toggle button in header section (near Print button):
   - Text: "Hide Completed" when OFF, "Show All" when ON
   - Style consistent with existing button style (blue bg, white text, rounded)
   - onClick handler that calls API and updates local state
   - Include `print:hidden` to hide from print view

3. Create toggleHideCompleted async function:
   - Optimistic update: toggle hideCompleted state immediately
   - Call PATCH /api/checklists/[checklistId] with {hideCompleted: !currentState}
   - On error: revert state and show error message
   - Follow established optimistic update pattern from toggleCompletion

4. Update groupItemsByTemplate or rendering logic to filter items:
   - When hideCompleted is true: filter out items where item.completed === true before grouping
   - Keep filtering logic after sorting by order

5. Update template group rendering:
   - When hideCompleted is true: skip rendering groups where ALL items are completed
   - Check if group has any incomplete items before rendering
   - Preserve existing collapse/expand functionality for visible groups

6. Ensure hideCompleted state is used consistently:
   - Progress calculation uses ALL items (completed + incomplete) regardless of hideCompleted
   - Only visual filtering is affected by hideCompleted

Follow established patterns:
- Optimistic UI updates with error reversion (like toggleCompletion)
- Dark mode color classes throughout (dark:bg-*, dark:text-*)
- print:hidden for interactive elements
- Accessible button styling with hover states
  </action>
  <verify>
Run `npm run dev` and navigate to a checklist with mix of completed/incomplete items:
- Toggle button appears in header
- Clicking toggle updates button text between "Hide Completed" and "Show All"
- When ON, completed items disappear from view
- When ON, template groups with all items completed disappear
- When OFF, all items and groups visible again
- Refresh page - hideCompleted state persists
- Progress bar still shows accurate total count (not affected by hide)
  </verify>
  <done>
- Toggle button renders in checklist detail header
- Clicking toggle updates hideCompleted via API and updates UI
- When hideCompleted is true, completed items are filtered from view
- When hideCompleted is true, fully completed template groups are hidden
- hideCompleted preference persists across page refreshes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Hide completed functionality in checklist detail view with per-checklist persistence.
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000 and log in
3. Open any checklist or create a new one with multiple template groups
4. Check off some items (leave some unchecked) in different groups
5. Test toggle button:
   - Click "Hide Completed" button
   - Verify completed items disappear immediately
   - Verify groups with all items completed disappear
   - Verify groups with mix of completed/incomplete items remain visible showing only incomplete items
   - Verify button text changes to "Show All"
   - Click "Show All"
   - Verify all items and groups reappear
6. Test persistence:
   - Enable "Hide Completed"
   - Refresh the page
   - Verify hide completed remains ON after refresh
   - Disable it, refresh again
   - Verify it remains OFF after refresh
7. Test multiple checklists:
   - Enable hide on checklist A
   - Navigate to checklist B
   - Verify checklist B starts with hide OFF (independent preference)
   - Navigate back to checklist A
   - Verify checklist A still has hide ON
8. Test edge cases:
   - Checklist with all items completed - verify all groups hidden when hide ON
   - Checklist with no completed items - verify toggle works but shows all items either way
   - Check an item while hide is ON - verify it disappears immediately
   - Uncheck an item while hide is ON - verify it reappears immediately
9. Test visual design:
   - Verify toggle button matches existing button styling
   - Verify dark mode styling works correctly
   - Test print preview - verify toggle button is hidden in print view

Expected behavior:
- Toggle button responds immediately with optimistic updates
- Completed items vanish smoothly when hide enabled
- Groups with all items completed disappear entirely
- Progress bar always shows total count (not affected by hide)
- Preference persists per-checklist across sessions
- Dark mode colors render correctly
- Print view excludes toggle button
  </how-to-verify>
  <resume-signal>
Type "approved" if functionality works as expected, or describe any issues found for fixes.
  </resume-signal>
</task>

</tasks>

<verification>
1. Database schema includes hideCompleted Boolean field on Checklist model
2. API PATCH endpoint accepts and persists hideCompleted preference
3. Checklist detail page has toggle button that calls API
4. When hideCompleted is true, completed items are filtered from display
5. When hideCompleted is true, fully completed groups are hidden
6. hideCompleted preference persists across page refreshes
7. Each checklist maintains independent hideCompleted state
8. Progress tracking counts all items regardless of hide state
9. Toggle button hidden in print view
10. Optimistic UI updates provide instant feedback
</verification>

<success_criteria>
- User can click toggle button to hide/show completed items
- Completed items disappear from view when hide is enabled
- Template groups with all items completed disappear when hide is enabled
- Hide/show preference saves to database and persists across sessions
- Multiple checklists maintain independent hide preferences
- Progress calculation unaffected by hide state
- Dark mode styling consistent with rest of application
- Print view excludes toggle button
</success_criteria>

<output>
After completion, create `.planning/phases/06-checklist-focus/06-01-SUMMARY.md` following the summary template.
</output>
