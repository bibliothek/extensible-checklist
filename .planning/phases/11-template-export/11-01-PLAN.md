---
phase: 11-template-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/templates/export/route.ts
  - app/templates/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can trigger template export from templates library page"
    - "Export downloads markdown file with timestamp in filename"
    - "Downloaded file contains all templates as headings with checkbox items"
    - "Template items appear in correct order matching the UI"
  artifacts:
    - path: "app/api/templates/export/route.ts"
      provides: "Export endpoint generating markdown from user templates"
      exports: ["GET"]
      min_lines: 60
    - path: "app/templates/page.tsx"
      provides: "Export button triggering download"
      contains: "Export"
  key_links:
    - from: "app/templates/page.tsx"
      to: "/api/templates/export"
      via: "fetch in handleExport function"
      pattern: "fetch.*api/templates/export"
    - from: "app/api/templates/export/route.ts"
      to: "db.template.findMany"
      via: "Prisma query with items"
      pattern: "db\\.template\\.findMany"
---

<objective>
Users can export all their templates to a markdown file for personal backup.

Purpose: Provides data portability and peace of mind - users can save their template library as a plain text file that works in any markdown viewer.

Output: Export API endpoint and UI button that downloads a timestamped markdown file containing all templates formatted as headings with checkbox items.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Existing patterns to follow
@app/api/templates/route.ts
@app/templates/page.tsx
@prisma/schema.prisma

# Recent relevant work
@.planning/phases/05-power-user-ux/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create markdown export API endpoint</name>
  <files>app/api/templates/export/route.ts</files>
  <action>
Create GET endpoint at `/api/templates/export` that:
1. Authenticates user via `auth()` from @/auth
2. Fetches all user templates with items using `db.template.findMany` (same pattern as GET /api/templates)
3. Formats templates as markdown:
   - Each template becomes `## {template.name}` heading
   - Each item becomes `- [ ] {item.text}` checkbox line
   - Items ordered by `order` field (ascending)
   - Templates ordered by `createdAt` (descending, most recent first)
   - Blank line between templates for readability
4. Returns Response with:
   - Content-Type: text/markdown
   - Content-Disposition: attachment; filename="templates-{YYYY-MM-DD-HHmmss}.md"
   - Body: generated markdown string

Follow error handling pattern from existing API routes (401 for unauthorized, 500 for errors).

Use existing imports: NextResponse, auth from @/auth, db from @/lib/db.
  </action>
  <verify>
```bash
# Start dev server
npm run dev

# In separate terminal, test endpoint (replace session cookie)
curl -X GET http://localhost:3000/api/templates/export -H "Cookie: authjs.session-token=YOUR_SESSION" --output test-export.md

# Verify file downloaded
ls -lh test-export.md

# Check markdown format
cat test-export.md
```

Expected output:
- File downloads with timestamp in filename
- Markdown contains `## Template Name` headings
- Each heading followed by `- [ ] Item text` lines
- Items in correct order
  </verify>
  <done>
- GET /api/templates/export returns 401 for unauthenticated requests
- Authenticated request returns markdown file with Content-Disposition header
- Filename includes timestamp in format: templates-2026-01-28-143052.md
- Markdown contains all user templates with items in correct order
- Empty checkbox format: `- [ ] ` (space between brackets and text)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export button to templates page</name>
  <files>app/templates/page.tsx</files>
  <action>
Add export functionality to templates library page:

1. Add `handleExport` async function:
   - Fetches `/api/templates/export`
   - Converts response to blob
   - Creates temporary anchor element with blob URL
   - Triggers download by clicking anchor
   - Cleans up blob URL after download
   - Handles errors by setting error state

2. Add export button in header section (next to "Create New Template" button):
   - Position: Left side of header, before Create button
   - Style: Secondary button styling (gray background like Edit button)
   - Text: "Export to Markdown"
   - Icon: Optional - use → or ↓ if desired
   - OnClick: calls handleExport
   - Loading state: disable during export with "Exporting..." text

3. Update error handling to show export errors in existing error banner

Follow existing patterns:
- Use same button styling as Edit/Delete buttons (gray background, dark mode support)
- Use existing error state and error banner component
- Match TypeScript typing patterns from existing handlers
- Use async/await pattern like handleDelete

Place button before "Create New Template" button in flex container.
  </action>
  <verify>
```bash
# Ensure dev server running
npm run dev

# Open browser to http://localhost:3000/templates
# Click "Export to Markdown" button
# Verify:
# 1. File downloads automatically
# 2. Filename has timestamp: templates-2026-01-28-143052.md
# 3. Open file - contains all templates with checkbox items
# 4. Items in same order as shown in UI
# 5. Button shows "Exporting..." during download
# 6. Error handling works (test by stopping server and clicking export)
```
  </verify>
  <done>
- Export button appears in templates page header
- Button is styled consistently with existing buttons (gray background, hover effect)
- Clicking button triggers markdown file download
- Downloaded filename includes timestamp
- File contains all templates formatted as markdown headings with checkbox items
- Template items appear in correct order matching UI display
- Button disabled during export with loading text
- Export errors display in existing error banner
  </done>
</task>

</tasks>

<verification>
**Manual testing checklist:**

1. Authentication check:
   - [ ] Unauthenticated request to /api/templates/export returns 401
   - [ ] Authenticated user can access endpoint

2. Export button:
   - [ ] Button visible on templates library page
   - [ ] Button positioned in header area
   - [ ] Dark mode styling works correctly

3. Export functionality:
   - [ ] Clicking button downloads file
   - [ ] Filename format: `templates-YYYY-MM-DD-HHmmss.md`
   - [ ] File contains markdown content

4. Markdown format:
   - [ ] Each template appears as `## Template Name` heading
   - [ ] Items formatted as `- [ ] Item text` checkboxes
   - [ ] Items ordered correctly (matching UI order)
   - [ ] Templates ordered by creation date (newest first)
   - [ ] Blank lines between templates for readability

5. Edge cases:
   - [ ] Export works with 0 templates (empty file or "No templates" message)
   - [ ] Export works with 1 template
   - [ ] Export works with many templates (10+)
   - [ ] Export works with templates containing special characters in names/items
   - [ ] Export works with templates containing very long item text

6. Error handling:
   - [ ] Network error shows user-friendly message
   - [ ] Server error (500) handled gracefully
</verification>

<success_criteria>
**Phase 11 success criteria met:**

1. ✓ User can trigger template export from templates library page (EXPORT-01)
2. ✓ Export downloads markdown file with timestamp (EXPORT-02)
3. ✓ Exported file contains all templates as headings with checkbox items (EXPORT-03)
4. ✓ Template items preserve order in exported markdown (EXPORT-04)

**Observable behaviors:**
- Export button visible and accessible on templates page
- Clicking button initiates file download
- Downloaded file has timestamp in filename
- File opens in any markdown viewer showing formatted templates
- Template content matches what user sees in UI
</success_criteria>

<output>
After completion, create `.planning/phases/11-template-export/11-01-SUMMARY.md` using the standard summary template.
</output>
