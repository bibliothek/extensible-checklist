---
phase: 07-production-deployment
plan: 03
type: execute
wave: 3
depends_on: [07-02]
files_modified: [.github/workflows/azure-deploy.yml, README.md]
autonomous: false

user_setup:
  - service: azure
    why: "Container hosting and deployment"
    env_vars:
      - name: AZURE_CREDENTIALS
        source: "Azure Portal -> App Registrations -> Certificates & Secrets -> Create service principal with Contributor role"
      - name: REGISTRY_USERNAME
        source: "Azure Container Registry -> Access keys -> Username"
      - name: REGISTRY_PASSWORD
        source: "Azure Container Registry -> Access keys -> Password"
    dashboard_config:
      - task: "Create Azure Container Registry"
        location: "Azure Portal -> Create a resource -> Container Registry"
        details: "Basic tier, enable Admin user"
      - task: "Create Azure App Service (Container)"
        location: "Azure Portal -> Create a resource -> Web App -> Container settings"
        details: "Choose Linux, Docker Container (Single Container), Azure Container Registry source"
      - task: "Configure App Service settings"
        location: "App Service -> Configuration -> Application settings"
        details: "Add DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL, WEBSITES_PORT=3000"
      - task: "Enable App Service health check"
        location: "App Service -> Monitoring -> Health check"
        details: "Path: /api/health, Check interval: 2 minutes"
      - task: "Add GitHub Secrets"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions"
        details: "Add AZURE_CREDENTIALS, REGISTRY_LOGIN_SERVER, REGISTRY_USERNAME, REGISTRY_PASSWORD, AZURE_WEBAPP_NAME"

must_haves:
  truths:
    - "Push to main branch triggers GitHub Actions workflow"
    - "Workflow builds Docker image and pushes to Azure Container Registry"
    - "Workflow deploys updated image to Azure App Service"
    - "Deployment includes Prisma migration step"
    - "README documents complete Azure setup and deployment process"
  artifacts:
    - path: ".github/workflows/azure-deploy.yml"
      provides: "CI/CD pipeline configuration"
      contains: "on: push:"
      min_lines: 60
    - path: "README.md"
      provides: "Deployment documentation"
      contains: "Azure"
      min_lines: 80
  key_links:
    - from: ".github/workflows/azure-deploy.yml"
      to: "Dockerfile"
      via: "docker build command"
      pattern: "docker build"
    - from: ".github/workflows/azure-deploy.yml"
      to: "Azure Container Registry"
      via: "docker push command"
      pattern: "docker push.*\\.azurecr\\.io"
    - from: ".github/workflows/azure-deploy.yml"
      to: "Azure App Service"
      via: "Azure deployment action"
      pattern: "azure/webapps-deploy"
---

<objective>
Create automated CI/CD pipeline for Azure deployment and document setup process for production deployment.

Purpose: Enable continuous deployment where every push to main automatically builds, tests health check, pushes to Azure Container Registry, and deploys to Azure App Service. Complete v2.0 milestone with production-ready deployment infrastructure. Documentation ensures new team members or future deployments can reproduce setup.

Output: GitHub Actions workflow for Azure deployment, comprehensive README with deployment instructions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-production-deployment/07-CONTEXT.md
@.planning/phases/07-production-deployment/07-01-PLAN.md
@.planning/phases/07-production-deployment/07-02-PLAN.md

# Current files
@README.md
@Dockerfile
@app/api/health/route.ts

# Phase context decisions
- Auto-deploy on push to main (no manual approval gate)
- Production secrets in Azure App Service settings (not GitHub Secrets)
- Document deployment configuration in README (not separate file)
- Direct container swap deployment (brief downtime acceptable)
- Health check endpoint already exists from 07-02
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for Azure deployment</name>
  <files>.github/workflows/azure-deploy.yml</files>
  <action>
Create GitHub Actions workflow that builds Docker image, pushes to Azure Container Registry, and deploys to Azure App Service on every push to main.

Workflow name: "Azure Production Deployment"

Trigger:
```yaml
on:
  push:
    branches: [main]
  workflow_dispatch:
```

Jobs:
1. **build-and-deploy**:
   - runs-on: ubuntu-latest

   Steps:
   a. Checkout code

   b. Log in to Azure Container Registry:
      - uses: docker/login-action@v3
      - registry: ${{ secrets.REGISTRY_LOGIN_SERVER }}
      - username: ${{ secrets.REGISTRY_USERNAME }}
      - password: ${{ secrets.REGISTRY_PASSWORD }}

   c. Build and push Docker image:
      - Build: docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/extensible-checklist:${{ github.sha }} .
      - Tag latest: docker tag ... :${{ github.sha }} ...:latest
      - Push both tags

   d. Deploy to Azure App Service:
      - uses: azure/webapps-deploy@v2
      - app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
      - images: ${{ secrets.REGISTRY_LOGIN_SERVER }}/extensible-checklist:${{ github.sha }}
      - publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}

   e. Verify deployment health:
      - Sleep 30s to allow migration and startup
      - curl health check endpoint
      - Exit 1 if not healthy

Environment variables and secrets referenced:
- REGISTRY_LOGIN_SERVER (e.g., myregistry.azurecr.io)
- REGISTRY_USERNAME
- REGISTRY_PASSWORD
- AZURE_WEBAPP_NAME
- AZURE_WEBAPP_PUBLISH_PROFILE (download from Azure Portal)

The workflow handles DEV-04 (build), DEV-05 (push to ACR), DEV-06 (deploy to Azure).
DEV-07 (migrations) is handled by the entrypoint script in the container itself.

Add comments explaining each step for maintainability.
  </action>
  <verify>
```bash
cat .github/workflows/azure-deploy.yml | grep "on: push:"
cat .github/workflows/azure-deploy.yml | grep "docker build"
cat .github/workflows/azure-deploy.yml | grep "azure/webapps-deploy"
cat .github/workflows/azure-deploy.yml | grep "/api/health"
```
Verify workflow triggers on push to main, builds Docker image, deploys to Azure, and verifies health.
  </verify>
  <done>
GitHub Actions workflow exists that triggers on push to main, builds Docker image with commit SHA tag, pushes to Azure Container Registry, deploys to Azure App Service, and verifies deployment health
  </done>
</task>

<task type="auto">
  <name>Task 2: Update README with comprehensive deployment documentation</name>
  <files>README.md</files>
  <action>
Replace the default Next.js README content with comprehensive documentation for the Extensible Checklist application.

Structure:
1. **Project Overview**
   - What this application does (checklist management)
   - Key features (templates, instantiation, bulk editing, printing, hide completed)

2. **Local Development**
   - Prerequisites (Node.js, Docker)
   - Setup steps:
     - Clone repo
     - Copy .env.example to .env
     - Install dependencies: npm install
     - Start database: docker-compose up postgres
     - Run migrations: npm run db:push
     - Start dev server: npm run dev
     - Access at http://localhost:3000

3. **Docker Development**
   - Prerequisites (Docker, Docker Compose)
   - Start full stack: docker-compose up --build
   - Access at http://localhost:3000
   - View logs: docker-compose logs -f app
   - Stop: docker-compose down

4. **Production Deployment (Azure)**
   - Prerequisites section (Azure subscription, CLI tools)

   - Step-by-step Azure setup:
     a. Create Azure Container Registry
        - Command: az acr create --resource-group RG --name REGISTRY --sku Basic --admin-enabled

     b. Create Azure App Service (Linux Container)
        - Command: az appservice plan create + az webapp create
        - Enable container settings pointing to ACR

     c. Configure App Service environment variables:
        - DATABASE_URL (container PostgreSQL connection string)
        - NEXTAUTH_SECRET (generate with openssl rand -base64 32)
        - NEXTAUTH_URL (https://your-app.azurewebsites.net)
        - WEBSITES_PORT=3000

     d. Enable App Service health check:
        - Path: /api/health
        - Interval: 2 minutes

     e. Configure GitHub Secrets:
        - REGISTRY_LOGIN_SERVER
        - REGISTRY_USERNAME
        - REGISTRY_PASSWORD
        - AZURE_WEBAPP_NAME
        - AZURE_WEBAPP_PUBLISH_PROFILE

   - How to get each secret:
     - ACR credentials: az acr credential show
     - Publish profile: Download from Azure Portal

   - Deployment process:
     - Push to main branch
     - GitHub Actions builds and deploys automatically
     - Check workflow status in Actions tab
     - Verify deployment at https://your-app.azurewebsites.net/api/health

5. **Database Migrations**
   - Development: npm run db:push
   - Production: Automatic via scripts/migrate-and-start.sh on container startup
   - Creating migrations: npx prisma migrate dev

6. **Tech Stack**
   - Next.js 16 (App Router)
   - React 19
   - TypeScript
   - Prisma + PostgreSQL
   - NextAuth.js
   - Tailwind CSS v4
   - Docker

Keep it concise but complete. Use code blocks for commands. Add notes where things commonly go wrong.
  </action>
  <verify>
```bash
cat README.md | grep "Azure"
cat README.md | grep "docker-compose"
cat README.md | grep "NEXTAUTH_SECRET"
wc -l README.md
```
Verify README contains sections for local dev, Docker, and Azure deployment. Should be at least 150 lines.
  </verify>
  <done>
README.md contains comprehensive documentation with local development setup, Docker usage, detailed Azure deployment steps including CLI commands and required secrets, database migration instructions, and tech stack overview
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Azure deployment pipeline and documentation. Claude has:
- Created GitHub Actions workflow for automated deployment
- Documented complete Azure setup process in README
- Configured health check verification in workflow
  </what-built>

  <how-to-verify>
**Review documentation:**
1. Read updated README.md
   - Verify Azure setup steps are clear and complete
   - Check that all required secrets are documented
   - Confirm Docker commands are correct

**Test workflow locally (optional):**
2. Review .github/workflows/azure-deploy.yml
   - Verify workflow structure makes sense
   - Check that secrets are referenced correctly
   - Confirm health check verification step exists

**Azure setup (when ready to deploy):**
3. Follow README instructions to:
   - Create Azure Container Registry
   - Create Azure App Service
   - Configure environment variables in App Service
   - Add GitHub secrets
   - Push to main to trigger deployment

**Verify deployment (after Azure setup):**
4. Check GitHub Actions workflow runs successfully
5. Visit https://your-app.azurewebsites.net/api/health
6. Should return: `{"status":"healthy","database":"connected"}`
7. Visit https://your-app.azurewebsites.net
8. Application should load and function correctly

**Note:** Full deployment verification requires Azure resources (costs money). If not deploying immediately, verify that documentation is clear and workflow looks correct.
  </how-to-verify>

  <resume-signal>
Type "approved" if documentation is clear and workflow looks correct, or describe any issues to fix
  </resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify workflow file:
```bash
cat .github/workflows/azure-deploy.yml
```

2. Verify README documentation:
```bash
cat README.md | grep -A 30 "Production Deployment"
```

3. Check workflow syntax (optional, requires act or GitHub CLI):
```bash
gh workflow view azure-deploy.yml
```

4. Validate Dockerfile is ready for workflow:
```bash
docker build -t test .
```

5. When Azure resources are provisioned and secrets added:
```bash
git add .
git commit -m "feat(07): add Azure deployment pipeline and documentation"
git push origin main
```

Watch GitHub Actions run. Verify deployment succeeds and health check passes.
</verification>

<success_criteria>
- GitHub Actions workflow triggers on push to main
- Workflow builds Docker image with commit SHA tag
- Workflow pushes image to Azure Container Registry
- Workflow deploys image to Azure App Service
- Workflow verifies deployment health via /api/health endpoint
- README documents complete Azure setup process with commands
- README documents all required GitHub secrets and where to find them
- README includes local development, Docker, and production deployment sections
- All requirements (DEV-01 through DEV-07) satisfied
- Phase 7 complete, v2.0 milestone achieved
</success_criteria>

<output>
After completion, create `.planning/phases/07-production-deployment/07-03-SUMMARY.md`
</output>
