---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - auth.ts
  - app/api/auth/[...nextauth]/route.ts
autonomous: true

must_haves:
  truths:
    - "User model exists in database with email and password fields"
    - "Auth.js can authenticate users via credentials provider"
    - "Sessions persist in database for 30 days with sliding window"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "User, Account, Session, VerificationToken models"
      contains: "model User"
    - path: "auth.ts"
      provides: "Auth.js configuration with Prisma adapter and credentials provider"
      exports: ["authOptions", "handlers"]
    - path: "app/api/auth/[...nextauth]/route.ts"
      provides: "Auth.js API route handler"
      exports: ["GET", "POST"]
  key_links:
    - from: "auth.ts"
      to: "prisma.user"
      via: "PrismaAdapter database queries"
      pattern: "PrismaAdapter\\(.*\\)"
    - from: "auth.ts"
      to: "credentials provider"
      via: "CredentialsProvider configuration"
      pattern: "CredentialsProvider\\(\\{"
---

<objective>
Establish authentication foundation with database schema and Auth.js configuration.

Purpose: Enable secure user authentication with email/password credentials, long-lived database sessions (30 days), and sliding window session refresh.

Output: User model in database, Auth.js configured with Prisma adapter, credentials provider ready for signup/login flows.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md

# Foundation from Phase 1
@.planning/phases/01-foundation/01-01-SUMMARY.md

# Existing infrastructure
@prisma/schema.prisma
@lib/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Authentication Database Schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add Auth.js required models to Prisma schema for email/password authentication with database sessions:

1. **User model:**
   - id: String @id @default(cuid())
   - email: String @unique (for login)
   - password: String (bcrypt hash)
   - emailVerified: DateTime? (for future email verification)
   - createdAt: DateTime @default(now())
   - updatedAt: DateTime @updatedAt
   - Relations: accounts, sessions

2. **Account model** (Auth.js standard):
   - id, userId, type, provider, providerAccountId
   - Standard Auth.js fields for OAuth future support
   - Relation: user

3. **Session model** (Auth.js database sessions):
   - id, sessionToken @unique, userId, expires
   - Relation: user

4. **VerificationToken model** (Auth.js standard):
   - identifier, token @unique, expires
   - Composite unique: [identifier, token]

Reference Auth.js Prisma adapter schema: https://authjs.dev/reference/adapter/prisma

After adding models, run `npm run db:push` to sync database schema.
  </action>
  <verify>
Run `npx prisma validate` to confirm schema is valid.
Run `npm run db:push` successfully without errors.
Run `npm run db:studio` and confirm User, Account, Session, VerificationToken tables exist.
  </verify>
  <done>
Prisma schema contains User model with email/password fields, plus Account, Session, VerificationToken models. Database synchronized with schema via db:push. Tables visible in Prisma Studio.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Auth.js with Credentials Provider</name>
  <files>auth.ts, app/api/auth/[...nextauth]/route.ts, package.json</files>
  <action>
Install and configure Auth.js (NextAuth.js v5) with Prisma adapter and credentials provider:

1. **Install dependencies:**
   ```
   npm install next-auth@beta @auth/prisma-adapter bcryptjs
   npm install -D @types/bcryptjs
   ```

2. **Create `auth.ts` in project root:**
   - Import NextAuth from "next-auth"
   - Import PrismaAdapter from "@auth/prisma-adapter"
   - Import db from "@/lib/db"
   - Import CredentialsProvider from "next-auth/providers/credentials"
   - Import bcrypt from "bcryptjs"

   Configuration:
   - adapter: PrismaAdapter(db)
   - session: { strategy: "database", maxAge: 30 * 24 * 60 * 60 (30 days) }
   - providers: [CredentialsProvider with email/password authorize function]
   - In authorize function: query User by email, verify password with bcrypt.compare, return user object or null
   - callbacks: { session: (session, user) => ({ ...session, user: { ...session.user, id: user.id } }) }

   Export `handlers` (GET/POST) and `auth` function for server components.

3. **Create API route `app/api/auth/[...nextauth]/route.ts`:**
   - Import { handlers } from "@/auth"
   - Export const { GET, POST } = handlers

4. **Update `.env.example`:**
   - Add NEXTAUTH_URL=http://localhost:3000
   - Add NEXTAUTH_SECRET=<generate-random-secret>

5. **Generate secret for local .env:**
   - Run `openssl rand -base64 32` to generate NEXTAUTH_SECRET
   - Add to .env file (don't commit the actual secret)

Use database session strategy (not JWT) per user requirements for long sessions and multiple device support.
  </action>
  <verify>
Run `npm run build` to confirm TypeScript compilation succeeds.
Check auth.ts exports handlers and auth function without errors.
Check app/api/auth/[...nextauth]/route.ts exists and exports GET, POST.
  </verify>
  <done>
Auth.js installed and configured with Prisma adapter. Database session strategy with 30-day expiry. Credentials provider defined with bcrypt password verification. API route handler created at /api/auth/[...nextauth]. Build passes without errors.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Prisma schema includes User, Account, Session, VerificationToken models
2. Database synchronized via `npm run db:push`
3. Auth.js configured in auth.ts with PrismaAdapter and CredentialsProvider
4. API route handler exists at app/api/auth/[...nextauth]/route.ts
5. Project builds successfully with `npm run build`
6. Session configuration: database strategy, 30-day maxAge
</verification>

<success_criteria>
Foundation complete when:
- User model exists in database with email (unique) and password fields
- Auth.js installed and configured with database sessions
- Credentials provider ready to authenticate email/password
- API route handler responds at /api/auth endpoint
- TypeScript compilation succeeds without auth-related errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
