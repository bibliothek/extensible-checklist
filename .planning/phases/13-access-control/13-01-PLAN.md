---
phase: 13-access-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/auth/signup/route.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "User with approved email can create account"
    - "User with non-approved email receives clear error message"
    - "Approved emails are configured via APPROVED_EMAILS environment variable"
    - "Existing users can log in normally (validation only on signup)"
  artifacts:
    - path: "app/api/auth/signup/route.ts"
      provides: "Email validation against approved list"
      contains: "APPROVED_EMAILS"
      min_lines: 60
    - path: ".env.example"
      provides: "APPROVED_EMAILS documentation"
      contains: "APPROVED_EMAILS"
  key_links:
    - from: "app/api/auth/signup/route.ts"
      to: "process.env.APPROVED_EMAILS"
      via: "environment variable read"
      pattern: "process\\.env\\.APPROVED_EMAILS"
    - from: "app/signup/page.tsx"
      to: "/api/auth/signup"
      via: "error message display"
      pattern: "setError"
---

<objective>
Implement email-based access control for signup with environment variable configuration.

Purpose: Restrict signup to pre-approved email addresses, enabling controlled access for small teams while maintaining simple configuration via environment variables.

Output: Modified signup API with email validation and updated .env.example with APPROVED_EMAILS documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Current auth implementation
@app/api/auth/signup/route.ts
@app/signup/page.tsx
@.env.example

# Related implementations
@auth.ts
</context>

<tasks>

<task type="auto">
  <name>Add email validation to signup API</name>
  <files>
app/api/auth/signup/route.ts
.env.example
  </files>
  <action>
Modify the signup API endpoint to validate emails against an approved list:

1. Add email validation function at top of file (before POST handler):
   - Read APPROVED_EMAILS from process.env
   - Split by comma, trim whitespace, convert to lowercase
   - Check if submitted email is in approved list
   - Return true if APPROVED_EMAILS is empty/undefined (open signup)

2. In POST handler, after existing email validation (line 11-16):
   - Call email validation function
   - If not approved, return 403 with clear message:
     "This email address is not approved for signup. Contact your administrator for access."
   - If approved, continue with existing flow (hash password, create user)

3. Update .env.example:
   - Add APPROVED_EMAILS variable with documentation
   - Example: APPROVED_EMAILS="user1@example.com,user2@example.com"
   - Note: Leave empty or omit to allow all signups (open mode)

Implementation notes:
- Place validation AFTER basic email format check but BEFORE password hashing
- Use 403 Forbidden (not 401 Unauthorized) for clarity
- Preserve existing error handling for duplicate emails (P2002)
- Do NOT modify login flow in auth.ts - validation is signup-only
- Case-insensitive email matching (both email.toLowerCase() and list.toLowerCase())
- Trim whitespace from both input email and approved list entries
  </action>
  <verify>
Test the validation logic:
1. Start dev server: npm run dev
2. Test approved email (if APPROVED_EMAILS set):
   - Visit http://localhost:3000/signup
   - Enter approved email + password
   - Should create account successfully
3. Test non-approved email:
   - Visit http://localhost:3000/signup
   - Enter non-approved email + password
   - Should see: "This email address is not approved for signup..."
4. Test empty/undefined APPROVED_EMAILS:
   - Remove or comment out APPROVED_EMAILS from .env
   - Restart server
   - Any email should work (open signup mode)
5. Test existing login unchanged:
   - Create account with approved email
   - Visit /login
   - Should log in successfully (no validation blocking)
  </verify>
  <done>
- APPROVED_EMAILS environment variable documented in .env.example
- Signup API validates email against approved list from environment variable
- Non-approved emails return 403 with clear message
- Approved emails (or empty list) allow signup to proceed normally
- Validation supports comma-separated format with trimming
- Login flow remains unchanged (validation only on signup)
  </done>
</task>

</tasks>

<verification>
Verify all access control requirements:

1. ACCESS-01: Signup validates email against approved list
   - Check app/api/auth/signup/route.ts has email validation function
   - Check function reads process.env.APPROVED_EMAILS
   - Check validation happens before user creation

2. ACCESS-02: Non-approved emails receive error message
   - Test with non-approved email
   - Verify 403 response with clear message

3. ACCESS-03: Approved email list supports comma-separated format
   - Check function splits by comma
   - Check function trims whitespace
   - Test with "email1@test.com, email2@test.com" format

4. ACCESS-04: Existing login functionality unchanged
   - Verify auth.ts not modified
   - Test login with existing user
   - Verify no validation during login
</verification>

<success_criteria>
Phase 13 complete when:

1. Environment variable configured:
   - .env.example includes APPROVED_EMAILS with documentation
   - Documentation explains comma-separated format
   - Documentation explains empty = open signup

2. Validation implemented:
   - app/api/auth/signup/route.ts validates emails
   - Validation reads from APPROVED_EMAILS env var
   - Validation is case-insensitive with trimming
   - Validation returns 403 for non-approved emails

3. Error messaging clear:
   - Non-approved emails see actionable error message
   - Error directs user to contact administrator
   - Error distinct from other validation errors

4. Existing flows preserved:
   - Login works unchanged for existing users
   - Approved users can create accounts normally
   - Empty/undefined APPROVED_EMAILS allows all signups

5. Manual verification passes:
   - Approved email creates account successfully
   - Non-approved email shows clear error
   - Existing user can log in
   - Empty env var allows any signup
</success_criteria>

<output>
After completion, create `.planning/phases/13-access-control/13-01-SUMMARY.md` following the summary template.
</output>
