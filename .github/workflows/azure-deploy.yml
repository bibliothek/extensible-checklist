# Azure Production Deployment
#
# This workflow automatically builds and deploys the Extensible Checklist
# application to Azure App Service on every push to the main branch.
#
# Prerequisites:
# - Azure Container Registry (ACR) created
# - Azure App Service (Linux Container) created
# - Azure Storage Account with File Share created for SQLite persistence
# - App Service configured with Azure Files volume mount at /app/data
# - GitHub secrets configured (REGISTRY_*, AZURE_WEBAPP_*)
#
# Environment variables configured in Azure App Service:
# - DATABASE_URL=file:/app/data/dev.db
# - NEXTAUTH_URL=https://<your-app>.azurewebsites.net
# - NEXTAUTH_SECRET=<generated-secret>

name: Azure Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

env:
  IMAGE_NAME: extensible-checklist

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        if: github.ref == 'refs/heads/master'
        env:
          DOCKER_USERNAME: ${{secrets.DOCKER_USERNAME}}
          DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}

      # Step 3: Build Docker image
      # Tags image with both commit SHA (for versioning) and 'latest'
      - name: Build Docker image
        run: |
          docker build -t mthaller/extensible-checklist:${{ github.sha }} .
          docker tag mthaller/extensible-checklist:${{ github.sha }} mthaller/extensible-checklist:latest

      # Step 4: Push Docker image to ACR
      # Pushes both the SHA-tagged and latest-tagged images
      - name: Push Docker image to ACR
        run: |
          docker push mthaller/extensible-checklist:${{ github.sha }}
          docker push mthaller/extensible-checklist:latest

